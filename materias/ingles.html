<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabiQuiz - ingles</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body data-subject-id="ingles">
    <div class="container level-selection-container">
        <a href="../main_menu.html" class="back-btn">← Volver a materias</a>
        <h3>Lenguaje</h3>
        <div id="level-grid" class="level-grid">
            <p>Cargando niveles...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { levels } from './ingles-data.js';

        const firebaseConfig = {
  apiKey: "AIzaSyDx_2b2rhaoRh7WawE9b-QVlVNj5PfycVA",
  authDomain: "sabiquiz-8f915.firebaseapp.com",
  projectId: "sabiquiz-8f915",
  storageBucket: "sabiquiz-8f915.firebasestorage.app",
  messagingSenderId: "1007656278742",
  appId: "1:1007656278742:web:a17a204b430d2638e74777",
  measurementId: "G-FB8HC6HV73"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- FUNCIÓN PARA DIBUJAR LOS BOTONES DE NIVEL ---
        function drawLevelButtons(profileProgress = {}) {
            const subjectId = document.body.dataset.subjectId;
            const levelGrid = document.getElementById('level-grid');
            levelGrid.innerHTML = '';

            const subjectProgress = profileProgress[subjectId] || {};

            levels.forEach(level => {
                const levelButton = document.createElement('a');
                levelButton.classList.add('level-btn');

                let isLocked = level.id > 1;
                const prevLevelStars = subjectProgress[level.id - 1]; // Progreso del nivel anterior
                if (level.id === 1 || (prevLevelStars && prevLevelStars > 0)) {
                    isLocked = false;
                }

                if (isLocked) {
                    levelButton.classList.add('locked');
                    levelButton.innerHTML = `<span>${level.title}</span> <img src="../img/lock.png" alt="Bloqueado" class="lock-icon">`;
                } else {
                    levelButton.href = `../quiz_runner.html?subject=${subjectId}&level=${level.id}`;
                    const starsWon = subjectProgress[level.id] || 0; // Estrellas de este nivel
                    let starsHTML = '<div class="stars-container">';
                    for (let i = 0; i < 3; i++) {
                        starsHTML += `<img src="../img/${i < starsWon ? 'star_filled.png' : 'star_empty.png'}" class="star-icon">`;
                    }
                    starsHTML += '</div>';
                    levelButton.innerHTML = `<span>${level.title}</span> ${starsHTML}`;
                }
                levelGrid.appendChild(levelButton);
            });
        }

        // --- VERIFICAMOS LA SESIÓN DEL USUARIO PARA OBTENER SU PROGRESO PERSONAL ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().quizProgress) {
                    // Si el usuario tiene progreso guardado, lo usamos para dibujar
                    drawLevelButtons(docSnap.data().quizProgress);
                } else {
                    // Si no tiene progreso, dibujamos el estado inicial (todo bloqueado)
                    drawLevelButtons();
                }
            } else {
                // Si no hay usuario, dibujamos el estado inicial
                drawLevelButtons();
            }
        });
    </script>
</body>
</html>