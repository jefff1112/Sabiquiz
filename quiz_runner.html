<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="quizTitle">SabiQuiz - Quiz</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap">
</head>
<body>
    <div class="container quiz-container">
        <a href="#" id="backBtn" class="back-btn" data-translate="backToLevels">‚Üê Volver a los niveles</a>
        <h3 id="subjectTitle">Cargando Quiz...</h3>
        <div id="quiz-game">
            <div class="quiz-status">
                <span data-translate="question">Pregunta</span> <span id="questionCounter"></span> | 
                <span data-translate="points">Puntos</span>: <span id="scoreDisplay">0</span> | 
                <span data-translate="time">Tiempo</span>: <span id="timerDisplay"></span>
            </div>
            <div id="currentQuestionCard" class="question-card">
                <p id="questionText"></p>
                <div id="optionsContainer" class="options-grid"></div>
            </div>
            <div class="quiz-footer">
                <img id="quizMascot" src="../img/confundido_perro_4.png" alt="Mascota del Quiz">
                <div id="feedback" class="feedback-message"></div>
            </div>
            <button id="nextQuestionBtn" class="next-btn" style="display:none;">Siguiente quiz</button>
        </div>
    </div>
    
    <audio id="correctSound" src="../img/correct.mp3"></audio>
    <audio id="incorrectSound" src="../img/incorrect.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { loadLanguage } from '../js/translations.js';

        const lang = localStorage.getItem('language') || 'es';
        loadLanguage();

        const firebaseConfig = {
  apiKey: "AIzaSyDx_2b2rhaoRh7WawE9b-QVlVNj5PfycVA",
  authDomain: "sabiquiz-8f915.firebaseapp.com",
  projectId: "sabiquiz-8f915",
  storageBucket: "sabiquiz-8f915.firebasestorage.app",
  messagingSenderId: "1007656278742",
  appId: "1:1007656278742:web:a17a204b430d2638e74777",
  measurementId: "G-FB8HC6HV73"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        const authReady = new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                unsubscribe();
                currentUser = user;
                resolve(user);
            });
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await authReady;
            
            const backBtn = document.getElementById('backBtn');
            const subjectTitle = document.getElementById('subjectTitle');
            const questionCounter = document.getElementById('questionCounter');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            const questionText = document.getElementById('questionText');
            const optionsContainer = document.getElementById('optionsContainer');
            const feedbackDiv = document.getElementById('feedback');
            const quizMascotElement = document.getElementById('quizMascot');
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            const quizGameEl = document.getElementById('quiz-game');
            const correctSound = document.getElementById('correctSound');
            const incorrectSound = document.getElementById('incorrectSound');
            
            const mascotImages = {
                thinking: '../img/confundido_perro_4.png',
                correct: '../img/celebrando_perro_2.png',
                incorrect: '../img/triste_perro_3.png',
                medal: '../img/medella_perro_5.png'
            };

            let currentQuestionIndex = 0;
            let score = 0;
            let timer;
            let level;

            const urlParams = new URLSearchParams(window.location.search);
            const subjectId = urlParams.get('subject');
            const levelId = parseInt(urlParams.get('level'), 10);
            
            if (!subjectId || !levelId) {
                subjectTitle.textContent = 'Materia o nivel no especificado.';
                quizGameEl.innerHTML = ''; return;
            }

            try {
                // La ruta ahora es relativa a la ra√≠z del sitio
                const subjectModule = await import(`/materias/${subjectId}-data.js`);
                level = subjectModule.levels.find(l => l.id === levelId);
            } catch (error) {
                console.error("No se pudo cargar el archivo de preguntas:", error);
                subjectTitle.textContent = 'Error al cargar los datos del quiz.';
                quizGameEl.innerHTML = ''; return;
            }

            if (!level) {
                subjectTitle.textContent = 'Nivel no encontrado.';
                quizGameEl.innerHTML = ''; return;
            }
            
            subjectTitle.textContent = `${subjectId.charAt(0).toUpperCase() + subjectId.slice(1)} - Nivel ${level.id}`;
            backBtn.href = `/materias/${subjectId}.html`;
            showQuestion();

            function showQuestion() {
                if (currentQuestionIndex >= level.questions.length) {
                    showResult();
                    return;
                }
                const questionData = level.questions[currentQuestionIndex];
                questionText.textContent = questionData.question[lang];
                optionsContainer.innerHTML = '';
                feedbackDiv.innerHTML = '';
                nextQuestionBtn.style.display = 'none';
                quizMascotElement.src = mascotImages.thinking;

                questionData.options[lang].forEach(optionText => {
                    const button = document.createElement('button');
                    button.classList.add('option-btn');
                    button.textContent = optionText;
                    button.addEventListener('click', () => checkAnswer(button, questionData.correctAnswer[lang]));
                    optionsContainer.appendChild(button);
                });
                
                questionCounter.textContent = `${currentQuestionIndex + 1}/${level.questions.length}`;
                scoreDisplay.textContent = score;
                startTimer(questionData.timeLimit || 20);
            }

            function checkAnswer(button, correctAnswer) {
                optionsContainer.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                clearInterval(timer);
                
                if (!button) {
                    feedbackDiv.innerHTML = `¬°Time's up! The correct answer was: <b>${correctAnswer}</b> ‚ùå`;
                    incorrectSound.play();
                } else if (button.textContent === correctAnswer) {
                    score++;
                    button.classList.add('correct');
                    feedbackDiv.innerHTML = "¬°Correct! üéâ";
                    correctSound.play();
                } else {
                    button.classList.add('incorrect');
                    feedbackDiv.innerHTML = `Incorrecto. The correct answer was: <b>${correctAnswer}</b> ‚ùå`;
                    incorrectSound.play();
                }
                
                if (button === null || button.textContent !== correctAnswer) {
                    optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent === correctAnswer) btn.classList.add('correct');
                    });
                }
                nextQuestionBtn.style.display = 'block';
                scoreDisplay.textContent = score;
            }

            async function showResult() {
                const finalScore = score / level.questions.length;
                const stars = calculateStars(finalScore, level.passingScore);
                
                // Mantenemos localStorage por ahora para la l√≥gica de estrellas
                const levelsCompleted = JSON.parse(localStorage.getItem('levelsCompleted')) || {};
                if (!levelsCompleted[subjectId]) levelsCompleted[subjectId] = {};
                const previousStars = levelsCompleted[subjectId][levelId]?.stars || 0;
                
                if (stars > previousStars) {
                    levelsCompleted[subjectId][levelId] = { score: finalScore, stars: stars };
                    localStorage.setItem('levelsCompleted', JSON.stringify(levelsCompleted));

                    if (currentUser) {
                        const previousXp = getXpFromStars(previousStars);
                        const newXp = getXpFromStars(stars);
                        const xpGained = newXp - previousXp;
                        if (xpGained > 0) {
                            const userDocRef = doc(db, "users", currentUser.uid);
                            try {
                                const fieldToUpdate = `quizProgress.${subjectId}.${levelId}`;
                                await updateDoc(userDocRef, {
                                    quizXp: increment(xpGained),
                                    [fieldToUpdate]: stars
                                });
                                await checkLevelUp(userDocRef);
                            } catch (error) { console.error("Error al actualizar XP y progreso:", error); }
                        }
                    }
                }
                
                const resultTextKey = finalScore >= level.passingScore ? 'levelCompleted' : 'levelFailed';
                quizGameEl.innerHTML = `
                    <div class="results-container">
                        <h4 data-translate="${resultTextKey}"></h4>
                        <p><span data-translate="finalScore"></span> ${score} / ${level.questions.length}</p>
                        <div class="result-stars">${Array(3).fill(0).map((_, i) => `<img src="../img/${i < stars ? 'star_filled.png' : 'star_empty.png'}" class="star-icon">`).join('')}</div>
                        <a href="/materias/${subjectId}.html" class="main-menu-btn" data-translate="backToLevels"></a>
                    </div>`;
                quizMascotElement.src = finalScore >= level.passingScore ? mascotImages.medal : mascotImages.incorrect;
                backBtn.style.display = 'none';
                loadLanguage();
            }

            function calculateStars(score, passingScore) {
                if (score >= 1) return 3;
                if (score >= passingScore + 0.2) return 2;
                if (score >= passingScore) return 1;
                return 0;
            }

            function getXpFromStars(stars) {
                if (stars === 3) return 50;
                if (stars === 2) return 25;
                if (stars === 1) return 10;
                return 0;
            }

            async function checkLevelUp(userDocRef) {
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) return;
                const profile = userDoc.data();
                const totalXp = (profile.quizXp || 0) + (profile.pvpXp || 0);
                const currentLevel = profile.level || 1;
                const requiredXpForNextLevel = currentLevel * 100;
                if (totalXp >= requiredXpForNextLevel) {
                    await updateDoc(userDocRef, { level: increment(1) });
                }
            }

            function startTimer(duration) {
                let timeLeft = duration;
                timerDisplay.textContent = timeLeft;
                timer = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        checkAnswer(null, level.questions[currentQuestionIndex].correctAnswer[lang]);
                    }
                }, 1000);
            }
            
            nextQuestionBtn.addEventListener('click', () => {
                currentQuestionIndex++;
                showQuestion();
            });
        });
    </script>
</body>
</html>
