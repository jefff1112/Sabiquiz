<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>SabiQuiz - Quiz</title>
ย ย <link rel="stylesheet" href="css/styles.css">
ย ย <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap">
</head>
<body>
ย ย <div class="container quiz-container">
ย ย ย ย <a href="#" id="backBtn" class="back-btn">โ Volver a los niveles</a>
ย ย ย ย <h3 id="subjectTitle"></h3>
ย ย ย ย <div id="quiz-game">
ย ย ย ย ย ย <div class="quiz-status">
ย ย ย ย ย ย ย ย Pregunta <span id="questionCounter"></span> | Puntos: <span id="scoreDisplay">0</span> | Tiempo: <span id="timerDisplay"></span>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="currentQuestionCard" class="question-card">
ย ย ย ย ย ย ย ย <p id="questionText"></p>
ย ย ย ย ย ย ย ย <div id="optionsContainer" class="options-grid">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="quiz-footer">
ย ย ย ย ย ย ย ย <img id="quizMascot" src="img/confundido_perro_4.png" alt="Mascota del Quiz">
ย ย ย ย ย ย ย ย <div id="feedback" class="feedback-message"></div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <button id="nextQuestionBtn" class="next-btn" style="display:none;">Siguiente Pregunta</button>
ย ย ย ย </div>
ย ย </div>
ย ย 
ย ย <audio id="correctSound" src="img/correct.mp3"></audio>
ย ย <audio id="incorrectSound" src="img/incorrect.mp3"></audio>

ย ย <script>
ย ย ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย ย ย ย const urlParams = new URLSearchParams(window.location.search);
ย ย ย ย ย ย const subjectId = urlParams.get('subject');
ย ย ย ย ย ย const levelId = parseInt(urlParams.get('level'), 10);

ย ย ย ย ย ย const backBtn = document.getElementById('backBtn');
ย ย ย ย ย ย const subjectTitle = document.getElementById('subjectTitle');
ย ย ย ย ย ย const questionCounter = document.getElementById('questionCounter');
ย ย ย ย ย ย const scoreDisplay = document.getElementById('scoreDisplay');
ย ย ย ย ย ย const timerDisplay = document.getElementById('timerDisplay');
ย ย ย ย ย ย const questionText = document.getElementById('questionText');
ย ย ย ย ย ย const optionsContainer = document.getElementById('optionsContainer');
ย ย ย ย ย ย const feedbackDiv = document.getElementById('feedback');
ย ย ย ย ย ย const quizMascotElement = document.getElementById('quizMascot');
ย ย ย ย ย ย const nextQuestionBtn = document.getElementById('nextQuestionBtn');
ย ย ย ย ย ย const currentQuestionCard = document.getElementById('currentQuestionCard');
ย ย ย ย ย ย 
ย ย ย ย ย ย const correctSound = new Audio('img/correct.mp3');
ย ย ย ย ย ย const incorrectSound = new Audio('img/incorrect.mp3');

ย ย ย ย ย ย const mascotImages = {
ย ย ย ย ย ย ย ย thinking: 'img/confundido_perro_4.png',
ย ย ย ย ย ย ย ย correct: 'img/celebrando_perro_2.png',
ย ย ย ย ย ย ย ย incorrect: 'img/triste_perro_3.png',
ย ย ย ย ย ย ย ย medal: 'img/medella_perro_5.png'
ย ย ย ย ย ย };

ย ย ย ย ย ย let currentQuestionIndex = 0;
ย ย ย ย ย ย let score = 0;
ย ย ย ย ย ย let timer;
ย ย ย ย ย ย let level;
ย ย ย ย ย ย 
ย ย ย ย ย ย if (subjectId && levelId) {
ย ย ย ย ย ย ย ย fetch(`materias/${subjectId}.html`)
ย ย ย ย ย ย ย ย ย ย .then(response => response.text())
ย ย ย ย ย ย ย ย ย ย .then(html => {
ย ย ย ย ย ย ย ย ย ย ย ย const tempDiv = document.createElement('div');
ย ย ย ย ย ย ย ย ย ย ย ย tempDiv.innerHTML = html;
ย ย ย ย ย ย ย ย ย ย ย ย const script = tempDiv.querySelector('script');
ย ย ย ย ย ย ย ย ย ย ย ย if (script) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย eval(script.textContent);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const subjectLevels = window.levels;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย level = subjectLevels.find(l => l.id === levelId);

ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (level) {
                                subjectTitle.textContent = `${subjectId.charAt(0).toUpperCase() + subjectId.slice(1)} - Nivel ${level.id}`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย backBtn.href = `materias/${subjectId}.html`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย showQuestion();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย subjectTitle.textContent = 'Nivel no encontrado.';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย quizGame.innerHTML = '';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย subjectTitle.textContent = 'No se encontraron datos de quiz para esta materia.';
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย ย ย .catch(error => {
ย ย ย ย ย ย ย ย ย ย ย ย console.error('Error loading subject data:', error);
ย ย ย ย ย ย ย ย ย ย ย ย subjectTitle.textContent = 'Error al cargar los datos del quiz.';
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย subjectTitle.textContent = 'Materia o nivel no especificado.';
ย ย ย ย ย ย ย ย quizGame.innerHTML = '';
ย ย ย ย ย ย }

ย ย ย ย ย ย function showQuestion() {
ย ย ย ย ย ย ย ย if (currentQuestionIndex < level.questions.length) {
ย ย ย ย ย ย ย ย ย ย const questionData = level.questions[currentQuestionIndex];
ย ย ย ย ย ย ย ย ย ย questionText.textContent = questionData.question;
ย ย ย ย ย ย ย ย ย ย optionsContainer.innerHTML = '';
ย ย ย ย ย ย ย ย ย ย feedbackDiv.innerHTML = '';
ย ย ย ย ย ย ย ย ย ย currentQuestionCard.classList.remove('correct-card', 'incorrect-card');
ย ย ย ย ย ย ย ย ย ย nextQuestionBtn.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย quizMascotElement.src = mascotImages.thinking;

ย ย ย ย ย ย ย ย ย ย questionData.options.forEach(option => {
ย ย ย ย ย ย ย ย ย ย ย ย const button = document.createElement('button');
ย ย ย ย ย ย ย ย ย ย ย ย button.classList.add('option-btn');
ย ย ย ย ย ย ย ย ย ย ย ย button.textContent = option;
ย ย ย ย ย ย ย ย ย ย ย ย button.addEventListener('click', () => checkAnswer(button));
ย ย ย ย ย ย ย ย ย ย ย ย optionsContainer.appendChild(button);
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย questionCounter.textContent = `${currentQuestionIndex + 1}/${level.questions.length}`;
ย ย ย ย ย ย ย ย ย ย scoreDisplay.textContent = score;
ย ย ย ย ย ย ย ย ย ย startTimer(questionData.timeLimit || 20);
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย showResult();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }

ย ย ย ย ย ย function checkAnswer(button) {
ย ย ย ย ย ย ย ย optionsContainer.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
ย ย ย ย ย ย ย ย clearInterval(timer);
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const questionData = level.questions[currentQuestionIndex];
ย ย ย ย ย ย ย ย const correctAnswer = questionData.correctAnswer;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Si no hay botรณn, el tiempo se agotรณ
ย ย ย ย ย ย ย ย if (!button) {
ย ย ย ย ย ย ย ย ย ย currentQuestionCard.classList.add('incorrect-card');
ย ย ย ย ย ย ย ย ย ย feedbackDiv.innerHTML = `Incorrecto. ยกSe acabรณ el tiempo! La respuesta correcta era: ${correctAnswer} โ`;
ย ย ย ย ย ย ย ย ย ย new Audio('img/incorrect.mp3').play();
ย ย ย ย ย ย ย ย ย ย quizMascotElement.src = mascotImages.incorrect;
ย ย ย ย ย ย ย ย } else if (button.textContent === correctAnswer) {
ย ย ย ย ย ย ย ย ย ย score++;
ย ย ย ย ย ย ย ย ย ย button.classList.add('correct');
ย ย ย ย ย ย ย ย ย ย currentQuestionCard.classList.add('correct-card');
ย ย ย ย ย ย ย ย ย ย feedbackDiv.innerHTML = "ยกCorrecto! ๐";
ย ย ย ย ย ย ย ย ย ย new Audio('img/correct.mp3').play();
ย ย ย ย ย ย ย ย ย ย quizMascotElement.src = mascotImages.correct;
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย button.classList.add('incorrect');
ย ย ย ย ย ย ย ย ย ย currentQuestionCard.classList.add('incorrect-card');
ย ย ย ย ย ย ย ย ย ย feedbackDiv.innerHTML = `Incorrecto. La respuesta correcta era: ${correctAnswer} โ`;
ย ย ย ย ย ย ย ย ย ย new Audio('img/incorrect.mp3').play();
ย ย ย ย ย ย ย ย ย ย quizMascotElement.src = mascotImages.incorrect;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Mostrar la respuesta correcta en todos los casos de error
ย ย ย ย ย ย ย ย if (button === null || button.textContent !== correctAnswer) {
ย ย ย ย ย ย ย ย ย ย optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
ย ย ย ย ย ย ย ย ย ย ย ย if (btn.textContent === correctAnswer) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย btn.classList.add('correct');
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย nextQuestionBtn.style.display = 'block';
ย ย ย ย ย ย ย ย scoreDisplay.textContent = score;
ย ย ย ย ย ย }

ย ย ย ย ย ย function showResult() {
ย ย ย ย ย ย ย ย const finalScore = score / level.questions.length;
ย ย ย ย ย ย ย ย const stars = calculateStars(finalScore, level.passingScore);
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const levelsCompleted = JSON.parse(localStorage.getItem('levelsCompleted')) || {};
ย ย ย ย ย ย ย ย if (!levelsCompleted[subjectId]) {
ย ย ย ย ย ย ย ย ย ย levelsCompleted[subjectId] = {};
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย levelsCompleted[subjectId][levelId] = { score: finalScore, stars: stars };
ย ย ย ย ย ย ย ย localStorage.setItem('levelsCompleted', JSON.stringify(levelsCompleted));

ย ย ย ย ย ย ย ย const resultText = finalScore >= level.passingScore ? 'ยกNivel Completado!' : 'ยกNivel Fallido!';
ย ย ย ย ย ย ย ย const resultClass = finalScore >= level.passingScore ? 'passed' : 'failed';
ย ย ย ย ย ย ย ย const mascotImage = finalScore >= level.passingScore ? mascotImages.medal : mascotImages.incorrect;

ย ย ย ย ย ย ย ย optionsContainer.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <div class="results-container ${resultClass}">
ย ย ย ย ย ย ย ย ย ย ย ย <h4>${resultText}</h4>
ย ย ย ย ย ย ย ย ย ย ย ย <p>Preguntas respondidas: ${level.questions.length}/${level.questions.length}</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p>Tu puntaje final: ${score}</p>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="result-stars">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${Array(3).fill('<img src="img/star_empty.png" alt="estrella vacรญa" class="star-icon">').map((star, index) =>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย index < stars ? '<img src="img/star_filled.png" alt="estrella llena" class="star-icon">' : star
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ).join('')}
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="window.location.href='materias/${subjectId}.html'" class="main-menu-btn">Volver a los niveles</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย questionText.textContent = '';
ย ย ย ย ย ย ย ย nextQuestionBtn.style.display = 'none';
ย ย ย ย ย ย ย ย backBtn.style.display = 'none';
ย ย ย ย ย ย ย ย feedbackDiv.innerHTML = '';
ย ย ย ย ย ย ย ย quizMascotElement.src = mascotImage;
ย ย ย ย ย ย }

ย ย ย ย ย ย function calculateStars(score, passingScore) {
ย ย ย ย ย ย ย ย if (score >= 1) return 3;
ย ย ย ย ย ย ย ย if (score >= passingScore + 0.2) return 2;
ย ย ย ย ย ย ย ย if (score >= passingScore) return 1;
ย ย ย ย ย ย ย ย return 0;
ย ย ย ย ย ย }

ย ย ย ย ย ย function startTimer(duration) {
ย ย ย ย ย ย ย ย let timeLeft = duration;
ย ย ย ย ย ย ย ย timerDisplay.textContent = timeLeft;
ย ย ย ย ย ย ย ย timer = setInterval(() => {
ย ย ย ย ย ย ย ย ย ย timeLeft--;
ย ย ย ย ย ย ย ย ย ย timerDisplay.textContent = timeLeft;
ย ย ย ย ย ย ย ย ย ย if (timeLeft <= 0) {
ย ย ย ย ย ย ย ย ย ย ย ย clearInterval(timer);
ย ย ย ย ย ย ย ย ย ย ย ย checkAnswer(null);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }, 1000);
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย nextQuestionBtn.addEventListener('click', () => {
ย ย ย ย ย ย ย ย currentQuestionIndex++;
ย ย ย ย ย ย ย ย showQuestion();
ย ย ย ย ย ย });
ย ย ย ย });
ย ย </script>
</body>
</html>