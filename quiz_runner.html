<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabiQuiz - Quiz</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyDx_2b2rhaoRh7WawE9b-QVlVNj5PfycVA",
  authDomain: "sabiquiz-8f915.firebaseapp.com",
  projectId: "sabiquiz-8f915",
  storageBucket: "sabiquiz-8f915.firebasestorage.app",
  messagingSenderId: "1007656278742",
  appId: "1:1007656278742:web:a17a204b430d2638e74777",
  measurementId: "G-FB8HC6HV73"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ... (El resto de tu script completo de quiz_runner.html que ya funcionaba) ...
        let currentUser = null;

        // --- EL "GUARDIA DE SEGURIDAD" DE AUTENTICACI√ìN ---
        const authReady = new Promise((resolve, reject) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                unsubscribe();
                currentUser = user;
                resolve(user);
            }, reject);
        });

        // --- 2. L√ìGICA DEL QUIZ (ESPERA AL "GUARDIA") ---
        document.addEventListener('DOMContentLoaded', async () => {
            await authReady;
            
            if (!currentUser) {
                console.error("Usuario no autenticado. El XP no se guardar√°.");
            }

            const backBtn = document.getElementById('backBtn');
            const subjectTitle = document.getElementById('subjectTitle');
            const questionCounter = document.getElementById('questionCounter');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            const questionText = document.getElementById('questionText');
            const optionsContainer = document.getElementById('optionsContainer');
            const feedbackDiv = document.getElementById('feedback');
            const quizMascotElement = document.getElementById('quizMascot');
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            const quizGameEl = document.getElementById('quiz-game');
            const correctSound = document.getElementById('correctSound');
            const incorrectSound = document.getElementById('incorrectSound');
            
            const mascotImages = {
                thinking: 'img/confundido_perro_4.png',
                correct: 'img/celebrando_perro_2.png',
                incorrect: 'img/triste_perro_3.png',
                medal: 'img/medella_perro_5.png'
            };

            let currentQuestionIndex = 0;
            let score = 0;
            let timer;
            let level;

            const urlParams = new URLSearchParams(window.location.search);
            const subjectId = urlParams.get('subject');
            const levelId = parseInt(urlParams.get('level'), 10);
            
            if (!subjectId || !levelId) {
                subjectTitle.textContent = 'Materia o nivel no especificado.';
                quizGameEl.innerHTML = ''; return;
            }

            try {
                const subjectModule = await import(`./materias/${subjectId}-data.js`);
                level = subjectModule.levels.find(l => l.id === levelId);
            } catch (error) {
                console.error("No se pudo cargar el archivo de preguntas:", error);
                subjectTitle.textContent = 'Error al cargar los datos del quiz.';
                quizGameEl.innerHTML = ''; return;
            }

            if (!level) {
                subjectTitle.textContent = 'Nivel no encontrado.';
                quizGameEl.innerHTML = ''; return;
            }
            
            subjectTitle.textContent = `${subjectId.charAt(0).toUpperCase() + subjectId.slice(1)} - Nivel ${level.id}`;
            backBtn.href = `materias/${subjectId}.html`;
            showQuestion();

            function showQuestion() {
                if (currentQuestionIndex >= level.questions.length) {
                    showResult();
                    return;
                }
                const questionData = level.questions[currentQuestionIndex];
                questionText.textContent = questionData.question;
                optionsContainer.innerHTML = '';
                feedbackDiv.innerHTML = '';
                nextQuestionBtn.style.display = 'none';
                quizMascotElement.src = mascotImages.thinking;
                questionData.options.forEach(option => {
                    const button = document.createElement('button');
                    button.classList.add('option-btn');
                    button.textContent = option;
                    button.addEventListener('click', () => checkAnswer(button));
                    optionsContainer.appendChild(button);
                });
                questionCounter.textContent = `${currentQuestionIndex + 1}/${level.questions.length}`;
                scoreDisplay.textContent = score;
                startTimer(questionData.timeLimit || 20);
            }

            function checkAnswer(button) {
                optionsContainer.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                clearInterval(timer);
                const questionData = level.questions[currentQuestionIndex];
                const correctAnswer = questionData.correctAnswer;
                if (!button) {
                    feedbackDiv.innerHTML = `¬°Se acab√≥ el tiempo! La respuesta correcta era: <b>${correctAnswer}</b> ‚ùå`;
                    incorrectSound.play();
                } else if (button.textContent === correctAnswer) {
                    score++;
                    button.classList.add('correct');
                    feedbackDiv.innerHTML = "¬°Correcto! üéâ";
                    correctSound.play();
                } else {
                    button.classList.add('incorrect');
                    feedbackDiv.innerHTML = `Incorrecto. La respuesta correcta era: <b>${correctAnswer}</b> ‚ùå`;
                    incorrectSound.play();
                }
                if (button === null || button.textContent !== correctAnswer) {
                    optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent === correctAnswer) btn.classList.add('correct');
                    });
                }
                nextQuestionBtn.style.display = 'block';
                scoreDisplay.textContent = score;
            }

            async function showResult() {
                const finalScore = score / level.questions.length;
                const stars = calculateStars(finalScore, level.passingScore);
                const levelsCompleted = JSON.parse(localStorage.getItem('levelsCompleted')) || {};
                if (!levelsCompleted[subjectId]) levelsCompleted[subjectId] = {};
                const previousStars = levelsCompleted[subjectId][levelId]?.stars || 0;
                
                if (stars > previousStars) {
                    levelsCompleted[subjectId][levelId] = { score: finalScore, stars: stars };
                    localStorage.setItem('levelsCompleted', JSON.stringify(levelsCompleted));
                    if (currentUser) {
                        const previousXp = getXpFromStars(previousStars);
                        const newXp = getXpFromStars(stars);
                        const xpGained = newXp - previousXp;
                        if (xpGained > 0) {
                            const userDocRef = doc(db, "users", currentUser.uid);
                            try {
                                const fieldToUpdate = `quizProgress.${subjectId}.${levelId}`;
                                await updateDoc(userDocRef, {
                                    quizXp: increment(xpGained),
                                    [fieldToUpdate]: stars
                                });
                                await checkLevelUp(userDocRef);
                            } catch (error) { console.error("Error al actualizar XP y progreso:", error); }
                        }
                    }
                }
                
                const resultText = finalScore >= level.passingScore ? '¬°Nivel Completado!' : '¬°Nivel Fallido!';
                quizGameEl.innerHTML = `
                    <div class="results-container">
                        <h4>${resultText}</h4>
                        <p>Tu puntaje: ${score} de ${level.questions.length}</p>
                        <div class="result-stars">${Array(3).fill(0).map((_, i) => `<img src="img/${i < stars ? 'star_filled.png' : 'star_empty.png'}" class="star-icon">`).join('')}</div>
                        <a href="materias/${subjectId}.html" class="main-menu-btn">Volver a los niveles</a>
                    </div>`;
                backBtn.style.display = 'none';
            }

            function calculateStars(score, passingScore) {
                if (score >= 1) return 3;
                if (score >= passingScore + 0.2) return 2;
                if (score >= passingScore) return 1;
                return 0;
            }

            function getXpFromStars(stars) {
                if (stars === 3) return 50;
                if (stars === 2) return 25;
                if (stars === 1) return 10;
                return 0;
            }

            async function checkLevelUp(userDocRef) {
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) return;
                const profile = userDoc.data();
                const totalXp = (profile.quizXp || 0) + (profile.pvpXp || 0);
                const currentLevel = profile.level || 1;
                const requiredXpForNextLevel = currentLevel * 100;
                if (totalXp >= requiredXpForNextLevel) {
                    await updateDoc(userDocRef, { level: increment(1) });
                }
            }

            function startTimer(duration) {
                let timeLeft = duration;
                timerDisplay.textContent = timeLeft;
                timer = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        checkAnswer(null);
                    }
                }, 1000);
            }
            
            nextQuestionBtn.addEventListener('click', () => {
                currentQuestionIndex++;
                showQuestion();
            });
        });
    </script>
</body>
</html>